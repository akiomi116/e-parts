<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>BOMãƒ“ãƒ¥ãƒ¼ã‚¢</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
  <style>
    html, body {
      height: 100%;
      overflow: hidden;
    }
    .main-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .content-row {
      flex-grow: 1;
      display: grid;
      grid-template-columns: 1fr 2fr; /* å·¦å³ã®æ¯”ç‡ï¼ˆå¯å¤‰ï¼‰ */
      grid-template-rows: 100%;
      overflow: hidden;
    }
    /* å·¦å´ï¼ˆéƒ¨å“è¡¨ï¼‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã§å¯å¤‰ã«ã™ã‚‹ */
    .scrollable-col {
      resize: horizontal;
      overflow-y: auto;
      overflow-x: hidden;
      min-width: 250px;
      max-width: 80vw;
      border-right: 3px solid #ddd;
    }
    .svg-container, .tab-content, .tab-pane {
      height: 100%;
      width: 100%;
    }
    .svg-container svg {
      width: 100%;
      height: 100%;
      touch-action: none;
    }
    #bom-table tbody tr {
      cursor: pointer;
    }
    #bom-table tbody tr.highlight td,
    #bom-table.table-hover tbody tr.highlight:hover td {
        background-color: #0d6efd !important;
        color: white !important;
        font-weight: bold;
    }
    #bom-table tbody tr.not-found td {
        background-color: #ffc107 !important;
        transition: background-color 0.2s ease-in-out;
    }
    g.svg-highlight text {
      fill: red !important;
      font-weight: bold;
    }
    g.svg-highlight path,
    g.svg-highlight rect,
    g.svg-highlight circle,
    g.svg-highlight polygon {
      filter: drop-shadow(0px 0px 2px red) drop-shadow(0px 0px 2px red);
      -webkit-filter: drop-shadow(0px 0px 2px red) drop-shadow(0px 0px 2px red);
      stroke: red !important;
      stroke-width: 1px;
    }
  </style>
</head>
<body>
  <div class="main-container p-3">
    <h1>BOM + å›è·¯å›³ / PCB ãƒ“ãƒ¥ãƒ¼ã‚¢</h1>
    <div class="content-row">
      <div class="scrollable-col p-2">
        <table id="bom-table" class="table table-striped table-hover">
          <thead>
            <tr><th>Ref</th><th>Value</th><th>Footprint</th><th>MPN</th><th>Qty</th></tr>
          </thead>
          <tbody>
            {% for line in lines %}
            <tr data-ref="{{ line.reference }}">
              <td>{{ line.reference }}</td>
              <td>{{ line.value }}</td>
              <td>{{ line.footprint }}</td>
              <td>{{ line.mpn }}</td>
              <td>{{ line.quantity }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="d-flex flex-column">
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#schematic">å›è·¯å›³</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pcb">åŸºæ¿å›³</button>
          </li>
        </ul>
        <div class="tab-content border border-top-0 flex-grow-1">
          <div class="tab-pane fade show active" id="schematic">
            <div id="schematic-container" class="svg-container"></div>
          </div>
          <div class="tab-pane fade" id="pcb">
            <div id="pcb-container" class="svg-container"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', function() {
  let activeRef = null;
  const schematicContainer = document.getElementById('schematic-container');
  const pcbContainer = document.getElementById('pcb-container');

  function highlightInSvg(svgElement, ref) {
    if (!svgElement) return false;
    let found = false;
    svgElement.querySelectorAll('g.svg-highlight').forEach(g => g.classList.remove('svg-highlight'));
    if (ref) {
      svgElement.querySelectorAll('g.stroked-text').forEach(strokedTextGroup => {
        const descElement = strokedTextGroup.querySelector('desc');
        if (descElement && descElement.textContent.trim() === ref) {
          strokedTextGroup.classList.add('svg-highlight');
          found = true;
        }
      });
    }
    return found;
  }

  // ğŸŒ€ ãƒªã‚µã‚¤ã‚ºå¯¾å¿œï¼šå³ãƒ‘ãƒãƒ«å¹…ã‚’è€ƒæ…®ã—ã¦ã‚¹ãƒ ãƒ¼ã‚ºãƒ‘ãƒ³
  function smoothPanTo(svgElement, bbox) {
    if (!svgElement || !svgElement.panZoomInstance) return;
    const panZoom = svgElement.panZoomInstance;
    const zoom = panZoom.getZoom();

    const rect = svgElement.getBoundingClientRect(); // â† ç¾åœ¨ã®å³é ˜åŸŸã‚µã‚¤ã‚ºã‚’å–å¾—
    const cx = bbox.x + bbox.width / 2;
    const cy = bbox.y + bbox.height / 2;

    const targetPan = {
      x: rect.width / 2 - cx * zoom,
      y: rect.height / 2 - cy * zoom
    };

    const currentPan = panZoom.getPan();
    const steps = 20;
    let step = 0;
    const deltaX = (targetPan.x - currentPan.x) / steps;
    const deltaY = (targetPan.y - currentPan.y) / steps;

    function animate() {
      if (step++ < steps) {
        panZoom.pan({
          x: currentPan.x + deltaX * step,
          y: currentPan.y + deltaY * step
        });
        requestAnimationFrame(animate);
      }
    }
    animate();
  }

  function highlightByRef(ref) {
    activeRef = (ref === activeRef) ? null : ref;

    document.querySelectorAll("#bom-table tr[data-ref]").forEach(row => {
      row.classList.remove('not-found');
      row.classList.toggle("highlight", row.dataset.ref === activeRef);
    });

    const foundInSchematic = highlightInSvg(schematicContainer.querySelector('svg'), activeRef);
    const foundInPcb = highlightInSvg(pcbContainer.querySelector('svg'), activeRef);

    if (activeRef && !foundInSchematic && !foundInPcb) {
      const row = document.querySelector(`#bom-table tr[data-ref="${activeRef}"]`);
      if (row) {
        row.classList.add('not-found');
        row.classList.remove('highlight');
        setTimeout(() => {
          if(row.dataset.ref === activeRef) row.classList.add('highlight');
          row.classList.remove('not-found');
        }, 1000);
      }
    }

    // âœ… ã‚ºãƒ¼ãƒ å›ºå®šã€ã‚¹ãƒ ãƒ¼ã‚ºãƒ‘ãƒ³ã®ã¿
    const activeSvg = foundInSchematic ? schematicContainer.querySelector('svg') :
                     foundInPcb ? pcbContainer.querySelector('svg') : null;
    if (activeSvg && activeRef) {
      const highlightedGroup = activeSvg.querySelector('g.svg-highlight');
      if (highlightedGroup) {
        const bbox = highlightedGroup.getBBox();
        smoothPanTo(activeSvg, bbox);
      }
    }
  }

  document.querySelectorAll("#bom-table tr[data-ref]").forEach(row => {
    row.addEventListener("click", () => highlightByRef(row.dataset.ref));
  });

  function initPanZoom(container, svgElement) {
    if (container.panZoomInitialized) return;

    const panZoomInstance = svgPanZoom(svgElement, {
      zoomEnabled: true,
      controlIconsEnabled: true,
      fit: true,
      center: true,
      minZoom: 0.1,
      maxZoom: 50,
      doubleClickZoomEnabled: false,
      onDblClick: function() {},
    });
    svgElement.panZoomInstance = panZoomInstance;
    container.panZoomInitialized = true;

    svgElement.addEventListener('click', (event) => {
      if (panZoomInstance.isPanning()) return;
      const target = event.target;
      const componentGroup = target.closest('g.stroked-text');
      let ref = null;
      if (componentGroup) {
        const descElement = componentGroup.querySelector('desc');
        if (descElement) ref = descElement.textContent.trim();
      }
      if (ref && !document.querySelector(`#bom-table tr[data-ref="${ref}"]`)) ref = null;
      highlightByRef(ref);
      if (activeRef) {
        const bomRow = document.querySelector(`#bom-table tr[data-ref="${activeRef}"]`);
        if (bomRow) bomRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });
  }

  async function loadAndInitSvg(container, url, isInitiallyActive) {
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const svgText = await response.text();
      container.innerHTML = svgText;
      const svgElement = container.querySelector('svg');
      if (!svgElement) throw new Error('SVG element not found.');

      container.svgElement = svgElement;
      if (isInitiallyActive) {
        initPanZoom(container, svgElement);
      } else {
        container.panZoomInitialized = false;
      }

      highlightByRef(null);
      checkMissingRefs(svgElement);

    } catch (e) {
      console.error(`Failed to load SVG from ${url}:`, e);
      container.innerHTML = `<div class="p-3 text-danger">Error loading SVG: ${e.message}</div>`;
    }
  }

  function checkMissingRefs(svgElement) {
    if (!svgElement) return;
    document.querySelectorAll("#bom-table tr[data-ref]").forEach(row => {
      const ref = row.dataset.ref;
      const found = [...svgElement.querySelectorAll('desc')].some(d => d.textContent.trim() === ref);
      if (!found) {
        row.classList.add('not-found');
      }
    });
  }

  // SVGãƒ­ãƒ¼ãƒ‰
  loadAndInitSvg(schematicContainer, "{{ url_for('static', filename=schematic_svg) }}", true);
  loadAndInitSvg(pcbContainer, "{{ url_for('static', filename=pcb_svg) }}", false);

  // âœ… å³é ˜åŸŸãŒãƒªã‚µã‚¤ã‚ºã•ã‚ŒãŸæ™‚ã«ã‚‚è‡ªå‹•è£œæ­£
  window.addEventListener('resize', () => {
    [schematicContainer, pcbContainer].forEach(container => {
      const svg = container.svgElement;
      if (svg && svg.panZoomInstance) {
        svg.panZoomInstance.resize();
        svg.panZoomInstance.fit();
        svg.panZoomInstance.center();
      }
    });
  });

  // ã‚¿ãƒ–åˆ‡æ›¿æ™‚ã«ã‚‚è£œæ­£
  document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
    tab.addEventListener('shown.bs.tab', function (event) {
      const paneId = event.target.getAttribute('data-bs-target');
      const container = document.querySelector(paneId + '-container');
      const svgElement = container.svgElement;
      if (svgElement) {
        if (!container.panZoomInitialized) {
          initPanZoom(container, svgElement);
        }
        if (svgElement.panZoomInstance) {
          svgElement.panZoomInstance.resize();
          svgElement.panZoomInstance.center();
          svgElement.panZoomInstance.fit();
        }
      }
    });
  });
});
</script>
</body>
</html>
